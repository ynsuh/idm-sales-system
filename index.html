<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDM 매출관리 시스템</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-lock"></i>
                <h1>IDM 매출관리 시스템</h1>
                <p>로그인이 필요합니다</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">사용자 이름</label>
                    <input type="text" id="username" placeholder="사용자 이름 입력" required>
                </div>
                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" placeholder="비밀번호 입력" required>
                </div>
                <div id="loginError" class="login-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>잘못된 사용자 이름 또는 비밀번호입니다.</span>
                </div>
                <button type="submit" class="btn btn-primary btn-login">
                    <i class="fas fa-sign-in-alt"></i> 로그인
                </button>
                <div class="login-info">
                    <i class="fas fa-info-circle"></i>
                    <p>접근 권한이 필요합니다. 관리자에게 문의하세요.</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> 관리자 설정</h2>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>🔐 비밀번호 변경</h3>
                    <form id="passwordChangeForm" class="settings-form">
                        <div class="form-group">
                            <label for="targetUser">사용자 선택</label>
                            <select id="targetUser" required>
                                <option value="">선택하세요</option>
                                <option value="admin">admin</option>
                                <option value="manager">manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="currentPassword">현재 비밀번호</label>
                            <input type="password" id="currentPassword" placeholder="현재 비밀번호 입력" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">새 비밀번호</label>
                            <input type="password" id="newPassword" placeholder="새 비밀번호 입력" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">새 비밀번호 확인</label>
                            <input type="password" id="confirmPassword" placeholder="새 비밀번호 재입력" required>
                        </div>
                        <div id="settingsError" class="login-error" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span></span>
                        </div>
                        <div id="settingsSuccess" class="success-message" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span>비밀번호가 성공적으로 변경되었습니다!</span>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 비밀번호 변경
                        </button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <h3>📊 적정 재고 기준 설정</h3>
                    <form id="dohSettingsForm" class="settings-form">
                        <div class="form-group">
                            <label for="targetDOH">목표 DOH (적정 재고 일수)</label>
                            <div class="input-with-unit">
                                <input type="number" id="targetDOH" min="15" max="60" value="30" required>
                                <span class="input-unit">일</span>
                            </div>
                            <small class="help-text">
                                <i class="fas fa-info-circle"></i>
                                현재 재고로 몇 일간 판매 가능할지 목표를 설정하세요 (권장: 25-45일)
                            </small>
                        </div>
                        <div class="doh-preview">
                            <div class="preview-item">
                                <span class="preview-label">과잉 재고 경고:</span>
                                <span class="preview-value" id="previewExcess">-</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">부족 재고 경고:</span>
                                <span class="preview-value" id="previewShortage">-</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">적정 재고 제안:</span>
                                <span class="preview-value" id="previewOptimal">-</span>
                            </div>
                        </div>
                        <div id="dohSettingsSuccess" class="success-message" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span>적정 재고 기준이 성공적으로 변경되었습니다!</span>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 적용
                        </button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>👥 사용자 관리</h3>
                    <div class="user-list">
                        <div class="user-item">
                            <span class="user-name">admin</span>
                            <span class="user-badge">관리자</span>
                        </div>
                        <div class="user-item">
                            <span class="user-name">manager</span>
                            <span class="user-badge">관리자</span>
                        </div>
                    </div>
                    <p class="info-text">
                        <i class="fas fa-info-circle"></i>
                        사용자 추가/삭제는 코드 수정이 필요합니다. (js/app.js)
                    </p>
                </div>

                <div class="settings-section">
                    <h3>⚠️ 보안 안내</h3>
                    <ul class="security-tips">
                        <li>비밀번호는 최소 6자 이상 권장</li>
                        <li>숫자, 영문, 특수문자 조합 권장</li>
                        <li>정기적으로 비밀번호 변경</li>
                        <li>비밀번호는 타인과 공유하지 마세요</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: none;">
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <h1>IDM 매출관리 시스템</h1>
                </div>
                <nav class="nav">
                    <span id="userDisplay" class="user-display"></span>
                    <button id="settingsBtn" class="btn btn-secondary" title="관리자 설정">
                        <i class="fas fa-cog"></i> 설정
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> 초기화
                    </button>
                    <button id="logoutBtn" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Upload Section -->
            <section id="uploadSection" class="section upload-section">
                <div class="section-header">
                    <h2><i class="fas fa-upload"></i> 데이터 업로드</h2>
                    <p>매출액과 도매상 재고금액 데이터를 업로드하세요</p>
                </div>

                <!-- Saved Data Notice -->
                <div id="savedDataNotice" class="saved-data-notice" style="display: none;">
                    <div class="saved-data-content">
                        <div class="saved-data-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="saved-data-info">
                            <h3>💾 저장된 데이터가 있습니다</h3>
                            <p id="savedDataDetails">-</p>
                        </div>
                    </div>
                    <div class="saved-data-actions">
                        <button class="btn btn-success" id="loadSavedDataBtn">
                            <i class="fas fa-download"></i> 이전 데이터 불러오기
                        </button>
                        <button class="btn btn-outline" id="deleteSavedDataBtn" title="저장된 데이터 삭제">
                            <i class="fas fa-trash"></i> 삭제
                        </button>
                    </div>
                </div>
                
                <div class="upload-container">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>파일을 드래그하거나 클릭하세요</h3>
                        <p>Excel (.xlsx, .xls) 또는 CSV 파일</p>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            파일 선택
                        </button>
                    </div>
                    
                    <div class="upload-info">
                        <h4>📋 데이터 형식</h4>
                        <p>파일은 다음 컬럼을 포함해야 합니다:</p>
                        <ul>
                            <li><strong>날짜</strong> (예: 2024-01, 2024-02)</li>
                            <li><strong>매출액</strong> (원 단위)</li>
                            <li><strong>재고금액</strong> (원 단위)</li>
                        </ul>
                        <button class="btn btn-outline" id="downloadSampleBtn">
                            <i class="fas fa-download"></i> 샘플 데이터 다운로드
                        </button>
                    </div>
                </div>

                <!-- Formula Guide -->
                <div class="formula-box">
                    <h3><i class="fas fa-calculator"></i> 주요 계산식 안내</h3>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <h4>📊 재고회전율</h4>
                            <div class="formula">매출액 ÷ 재고금액</div>
                            <p class="description">재고가 매출로 전환되는 속도 (높을수록 효율적)</p>
                        </div>
                        <div class="formula-item">
                            <h4>📅 소진율 (DOH)</h4>
                            <div class="formula">재고금액 ÷ (매출액 ÷ 30일)</div>
                            <p class="description">현재 재고로 몇 일간 판매 가능한지 (적정: 30-45일)</p>
                        </div>
                        <div class="formula-item">
                            <h4>🤖 다음 달 예상 매출</h4>
                            <div class="formula">(현재재고 × 평균회전율 × 0.6) + (트렌드예측 × 0.4)</div>
                            <p class="description">재고 소진율(60%)과 트렌드 분석(40%)을 결합한 AI 예측</p>
                        </div>
                        <div class="formula-item">
                            <h4>📈 적정 재고 수준</h4>
                            <div class="formula">(예상매출 ÷ 30일) × 목표DOH</div>
                            <p class="description">다음 달 예상 매출 기준 권장 재고 금액 (목표DOH는 설정에서 변경 가능)</p>
                        </div>
                    </div>
                </div>

                <!-- Data Preview -->
                <div id="dataPreview" class="data-preview" style="display: none;">
                    <h3><i class="fas fa-table"></i> 데이터 미리보기</h3>
                    <div class="table-container">
                        <table id="previewTable">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>매출액 (원)</th>
                                    <th>재고금액 (원)</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-success" id="analyzeBtn">
                        <i class="fas fa-chart-bar"></i> 분석 시작
                    </button>
                </div>
            </section>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="section dashboard-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-chart-pie"></i> 분석 대시보드</h2>
                </div>

                <!-- Manager Filter -->
                <div class="filter-section">
                    <div class="filter-container">
                        <label for="managerFilter" class="filter-label">
                            <i class="fas fa-user-tie"></i> 담당자 선택:
                        </label>
                        <select id="managerFilter" class="filter-select">
                            <option value="all">전체 (모든 담당자)</option>
                        </select>
                        <div class="filter-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="filterInfoText">전체 담당자의 데이터를 표시하고 있습니다</span>
                        </div>
                    </div>
                </div>

                <!-- Product Filter -->
                <div class="filter-section">
                    <div class="filter-container">
                        <label for="productFilter" class="filter-label">
                            <i class="fas fa-box"></i> 제품 선택:
                        </label>
                        <select id="productFilter" class="filter-select">
                            <option value="all">전체 (모든 제품)</option>
                        </select>
                        <div class="filter-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="productFilterInfoText">전체 제품의 데이터를 표시하고 있습니다</span>
                        </div>
                    </div>
                </div>

                <!-- Target DOH Setting -->
                <div class="filter-section doh-setting-section">
                    <div class="filter-container">
                        <label for="targetDOHDashboard" class="filter-label">
                            <i class="fas fa-bullseye"></i> 목표 DOH (적정 재고 일수):
                        </label>
                        <div class="doh-input-group">
                            <input type="number" id="targetDOHDashboard" class="doh-input" min="15" max="60" value="30">
                            <span class="input-unit-inline">일</span>
                            <button class="btn btn-primary btn-apply-doh" id="applyDOHBtn">
                                <i class="fas fa-check"></i> 적용
                            </button>
                        </div>
                        <div class="filter-info doh-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="dohInfoText">현재 목표: <strong>30일</strong> | 과잉 경고: 45일 초과 | 부족 경고: 15일 미만</span>
                        </div>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon blue">
                            <i class="fas fa-won-sign"></i>
                        </div>
                        <div class="kpi-content">
                            <h3>
                                현재 재고금액
                                <span class="tooltip-icon" data-tooltip="업로드된 데이터의 마지막 월 재고금액">?</span>
                            </h3>
                            <p class="kpi-value" id="currentInventory">-</p>
                            <span class="kpi-label">최근 월 기준</span>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon green">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="kpi-content">
                            <h3>
                                평균 재고회전율
                                <span class="tooltip-icon" data-tooltip="계산식: 매출액 ÷ 재고금액 (전체 기간 평균)">?</span>
                            </h3>
                            <p class="kpi-value" id="avgTurnover">-</p>
                            <span class="kpi-label">월별 평균</span>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon purple">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="kpi-content">
                            <h3>
                                평균 소진율 (DOH)
                                <span class="tooltip-icon" data-tooltip="계산식: 재고금액 ÷ (매출액 ÷ 30일) | 의미: 현재 재고로 몇 일간 판매 가능한지">?</span>
                            </h3>
                            <p class="kpi-value" id="avgDOH">-</p>
                            <span class="kpi-label">일 단위</span>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon orange">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="kpi-content">
                            <h3>
                                다음 달 예상 매출
                                <span class="tooltip-icon" data-tooltip="계산식: (현재재고 × 평균회전율 × 0.6) + (트렌드예측 × 0.4)">?</span>
                            </h3>
                            <p class="kpi-value" id="currentSales">-</p>
                            <span class="kpi-label" id="salesTrend">AI 예측 기반</span>
                        </div>
                    </div>

                    <div class="kpi-card kpi-card-highlight">
                        <div class="kpi-icon yellow">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="kpi-content">
                            <h3>
                                목표 DOH 기준 적정 매출
                                <span class="tooltip-icon" data-tooltip="계산식: (현재재고 ÷ 목표DOH) × 30일 | 목표 재고 일수에 맞춘 적정 매출액">?</span>
                            </h3>
                            <p class="kpi-value" id="optimalSales">-</p>
                            <span class="kpi-label" id="optimalSalesLabel">목표 30일 기준</span>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <div id="alertsContainer" class="alerts-container">
                    <!-- Alerts will be dynamically inserted here -->
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-area"></i> 매출 트렌드</h3>
                        <canvas id="salesTrendChart"></canvas>
                    </div>

                    <div class="chart-card">
                        <h3><i class="fas fa-brain"></i> AI 매출 예측</h3>
                        <canvas id="forecastChart"></canvas>
                    </div>

                    <div class="chart-card">
                        <h3><i class="fas fa-boxes"></i> 재고 현황</h3>
                        <canvas id="inventoryChart"></canvas>
                    </div>

                    <div class="chart-card">
                        <h3><i class="fas fa-chart-bar"></i> 재고회전율 & DOH</h3>
                        <canvas id="metricsChart"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="chart-card">
                    <h3><i class="fas fa-table"></i> 월별 상세 데이터</h3>
                    <div class="table-container">
                        <table id="detailsTable">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>매출액</th>
                                    <th>재고금액</th>
                                    <th>재고회전율</th>
                                    <th>DOH (일)</th>
                                    <th>증감률 (MoM)</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Formula Reference -->
                <div class="formula-box">
                    <h3><i class="fas fa-book"></i> 계산식 및 지표 설명</h3>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <h4>📊 재고회전율 (Inventory Turnover Ratio)</h4>
                            <div class="formula">재고회전율 = 매출액 ÷ 재고금액</div>
                            <p class="description">
                                <strong>의미:</strong> 재고가 매출로 전환되는 속도<br>
                                <strong>적정 범위:</strong> 2.0 ~ 3.0 (제약 유통)<br>
                                <strong>높을 때:</strong> 재고 효율 좋음, 품절 위험 주의<br>
                                <strong>낮을 때:</strong> 과잉 재고, 유동성 부족
                            </p>
                        </div>
                        <div class="formula-item">
                            <h4>📅 소진율 (DOH - Days on Hand)</h4>
                            <div class="formula">DOH = 재고금액 ÷ (매출액 ÷ 30일)</div>
                            <p class="description">
                                <strong>의미:</strong> 현재 재고로 몇 일간 판매 가능한지<br>
                                <strong>적정 범위:</strong> 30 ~ 45일<br>
                                <strong>45일 초과:</strong> 재고 과다, 관리 비용 증가<br>
                                <strong>15일 미만:</strong> 재고 부족, 품절 위험
                            </p>
                        </div>
                        <div class="formula-item">
                            <h4>🤖 AI 매출 예측 (Hybrid Forecasting)</h4>
                            <div class="formula">
                                재고 기반 = 현재재고 × 평균회전율<br>
                                트렌드 기반 = 가중이동평균 + 선형트렌드<br>
                                최종예측 = (재고기반 × 0.6) + (트렌드 × 0.4)
                            </div>
                            <p class="description">
                                <strong>방법:</strong> 재고 소진율(60%)과 트렌드 분석(40%) 결합<br>
                                <strong>장점:</strong> 실제 재고 수준 반영 + 시장 트렌드 고려
                            </p>
                        </div>
                        <div class="formula-item">
                            <h4>📈 적정 재고 수준 (Optimal Inventory)</h4>
                            <div class="formula">적정 재고 = (예상매출 ÷ 30일) × 목표DOH</div>
                            <p class="description">
                                <strong>목표 DOH:</strong> 설정에서 조정 가능 (기본: 30일)<br>
                                <strong>활용:</strong> 다음 달 발주 계획 수립<br>
                                <strong>조정:</strong> 계절성, 프로모션 고려하여 조정
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Download Report -->
                <div class="actions">
                    <button class="btn btn-primary" id="downloadReportBtn">
                        <i class="fas fa-file-download"></i> 분석 리포트 다운로드 (CSV)
                    </button>
                    <button class="btn btn-outline" onclick="window.print()">
                        <i class="fas fa-print"></i> 인쇄
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 IDM 매출관리 시스템. All rights reserved.</p>
            <p>제약회사 유통관리를 위한 스마트 솔루션</p>
        </div>
    </footer>
    
    </div>
    <!-- End of Main App -->

    <script src="js/app.js"></script>
</body>
</html>
